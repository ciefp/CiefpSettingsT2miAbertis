import os
import platform
import shutil
import json
import re
from datetime import datetime
from urllib.request import urlopen
from enigma import eConsoleAppContainer, eDVBDB, eTimer


from Screens.MessageBox import MessageBox
from Screens.Screen import Screen
from Components.ActionMap import ActionMap
from Components.Label import Label
from Components.Button import Button
from Tools.Directories import resolveFilename, SCOPE_PLUGINS
from Plugins.Plugin import PluginDescriptor


PLUGIN_VERSION = "1.9"
PLUGIN_NAME = "CiefpSettingsT2miAbertis"
ICON_PATH = "/usr/lib/enigma2/python/Plugins/Extensions/CiefpSettingsT2miAbertis/icon.png"

GITHUB_ZIPPED_ROOT_API = "https://api.github.com/repos/ciefp/ciefpsettings-enigma2-zipped/contents/"
MOTOR_ZIP_PATTERN = re.compile(r"^ciefp-E2-75E-34W-(\d{2}\.\d{2}\.\d{4})\.zip$", re.IGNORECASE)


class CiefpSettingsT2miAbertis(Screen):
    skin = """
    <screen name="CiefpSettingsT2miAbertis" position="center,center" size="1600,800" title="CiefpSettings T2mi Abertis Installer (v{version})">
        <widget name="info" position="10,10" size="780,650" font="Regular;24" valign="center" halign="left" />
        <ePixmap pixmap="/usr/lib/enigma2/python/Plugins/Extensions/CiefpSettingsT2miAbertis/background.png" position="790,10" size="800,650" alphatest="on" />

        <widget name="status" position="10,670" size="1580,50" font="Bold;24" valign="center" halign="center" backgroundColor="#cccccc" foregroundColor="#000000" />

        <widget name="key_red" position="10,730" size="370,60" font="Bold;26" halign="center" backgroundColor="#9F1313" foregroundColor="#000000" />
        <widget name="key_green" position="410,730" size="370,60" font="Bold;26" halign="center" backgroundColor="#1F771F" foregroundColor="#000000" />
        <widget name="key_yellow" position="810,730" size="370,60" font="Bold;26" halign="center" backgroundColor="#D6A200" foregroundColor="#000000" />
        <widget name="key_blue" position="1210,730" size="380,60" font="Bold;26" halign="center" backgroundColor="#1E5AA8" foregroundColor="#000000" />
    </screen>
    """.format(version=PLUGIN_VERSION)

    def __init__(self, session):
        self.session = session
        Screen.__init__(self, session)
        self._container = None
        self._on_cmd_done = None
        # Retry copy on clean install (astra-sm may auto-start and lock script briefly)
        self._copy_attempt = 0
        self._max_copy_attempts = 2  # ukupno 2 pokušaja
        self._retry_timer = eTimer()
        try:
            self._retry_timer_conn = self._retry_timer.timeout.connect(self._retryCopyNow)  # noviji imidži
        except Exception:
            self._retry_timer.callback.append(self._retryCopyNow)  # stariji imidži
        self.setupUI()
        self.showPrompt()

    def setupUI(self):
        self["info"] = Label("Initializing plugin...")
        self["status"] = Label("")
        self["key_red"] = Button("Exit")
        self["key_green"] = Button("Install")
        self["key_yellow"] = Button("Update")
        self["key_blue"] = Button("Motor Settings")

        self["actions"] = ActionMap(["ColorActions", "SetupActions"], {
            "red": self.exitPlugin,
            "green": self.startInstallation,
            "yellow": self.runUpdate,
            "blue": self.installMotorSettings,
            "cancel": self.close
        }, -1)

    def showPrompt(self):
        self["info"].setText(
            "GREEN (Install):\n"
            "- Check if Astra-SM is already installed\n"
            "- Stop Astra-SM, copy config/scripts, start Astra-SM\n\n"
            "BLUE (Motor Settings):\n"
            "- Download latest 'ciefp-E2-75E-34W' ZIP from GitHub\n"
            "- Install to /etc/enigma2 (+ satellites.xml if present)\n"
            "- Reload servicelist & bouquets\n\n"
            "YELLOW (Update):\n"
            "- Update installer script\n\n"
            "Choose an option."
        )
        self["status"].setText("Awaiting your choice.")

    def runCommandAsync(self, command, done_cb=None, status_text=None):
        if status_text:
            self["status"].setText(status_text)
        if self._container is not None:
            self["status"].setText("Busy, please wait...")
            return
        self._on_cmd_done = done_cb
        self._container = eConsoleAppContainer()
        self._container.appClosed.append(self._commandFinished)
        try:
            self._container.execute(command)
        except Exception as e:
            self._container = None
            self._on_cmd_done = None
            self["status"].setText("Command start failed: %s" % str(e))

    def _commandFinished(self, retval):
        cb = self._on_cmd_done
        self._container = None
        self._on_cmd_done = None
        if cb:
            try:
                cb(retval)
            except Exception as e:
                self["status"].setText("Callback error: %s" % str(e))

    def safe_copy_executable(self, src, dest, mode=0o755):
        tmp = dest + ".new"
        shutil.copy2(src, tmp)
        os.chmod(tmp, mode)
        os.rename(tmp, dest)

    def runUpdate(self):
        cmd = 'wget -q "--no-check-certificate" https://raw.githubusercontent.com/ciefp/CiefpSettingsT2miAbertis/main/installer.sh -O - | /bin/sh'
        self.runCommandAsync(cmd, done_cb=self._updateDone, status_text="Updating plugin...")

    def _updateDone(self, retval):
        self["status"].setText("Update complete." if retval == 0 else "Update failed (code %d)." % retval)

    def startInstallation(self):
        self._copy_attempt = 0
        system_info = platform.machine()
        if system_info not in ["mips", "arm", "armv7", "armv7l"]:
            self["status"].setText("Unsupported architecture: %s" % system_info)
            return

        # Avoid long opkg update if astra-sm is already installed
        self["info"].setText("Checking if Astra-SM is already installed...")
        self.runCommandAsync(
            "opkg list-installed 2>/dev/null | grep -qi '^astra-sm '",
            done_cb=self._astraCheckDone,
            status_text="Checking Astra-SM..."
        )

    def _astraCheckDone(self, retval):
        if retval == 0:
            self["info"].setText("Astra-SM already installed. Proceeding...")
            self._astraInstalledStopForCopy(0)
        else:
            self["info"].setText("Installing Astra-SM (opkg)...")
            self.runCommandAsync(
                "opkg install astra-sm",
                done_cb=self._astraInstalledStopForCopy,
                status_text="Installing Astra-SM..."
            )

    def _astraInstalledStopForCopy(self, retval):
        self["info"].setText("Stopping Astra-SM to copy files safely...")
        stop_cmd = (
            "if [ -x /etc/init.d/astra-sm ]; then /etc/init.d/astra-sm stop >/dev/null 2>&1; fi; "
            "killall -9 astra-sm >/dev/null 2>&1; "
        )
        self.runCommandAsync(stop_cmd, done_cb=self._copyPluginFiles, status_text="Stopping Astra-SM...")

    def _copyPluginFiles(self, retval):
        self._copy_attempt += 1
        try:
            self["info"].setText(
                "Copying configuration files... (attempt %d/%d)" % (self._copy_attempt, self._max_copy_attempts))
            self["status"].setText("Copying files...")

            for d in ["/etc/astra", "/etc/astra/scripts", "/etc/tuxbox/config", "/etc/tuxbox/config/oscam-emu"]:
                os.makedirs(d, exist_ok=True)

            data_dir = resolveFilename(SCOPE_PLUGINS, "Extensions/CiefpSettingsT2miAbertis/data/")

            shutil.copy2(os.path.join(data_dir, "sysctl.conf"), "/etc/sysctl.conf")
            shutil.copy2(os.path.join(data_dir, "astra.conf"), "/etc/astra/astra.conf")

            system_info = platform.machine()
            script_arch = "arm" if system_info in ["arm", "armv7",
                                                   "armv7l"] else "mips" if system_info == "mips" else None
            if not script_arch:
                raise Exception("Unsupported architecture: %s" % system_info)

            # OVO zna da “zapne” na clean install -> retry
            self.safe_copy_executable(os.path.join(data_dir, script_arch, "abertis"), "/etc/astra/scripts/abertis",
                                      mode=0o755)

            src_softcam = os.path.join(data_dir, "SoftCam.Key")
            shutil.copy2(src_softcam, "/etc/tuxbox/config/softcam.key")
            shutil.copy2(src_softcam, "/etc/tuxbox/config/oscam-emu/softcam.key")

        except Exception as e:
            if self._copy_attempt < self._max_copy_attempts:
                self["status"].setText("Copy failed: %s. Retrying in 30s..." % str(e))
                self["info"].setText("Waiting 30 seconds then retry copy (attempt %d/%d)..." % (
                self._copy_attempt + 1, self._max_copy_attempts))
                try:
                    self._retry_timer.start(30000, True)  # 30s one-shot (noviji)
                except Exception:
                    self._retry_timer.start(30000, 1)  # 30s one-shot (stariji)
                return

            self["status"].setText("Copy error: %s" % str(e))
            self.runCommandAsync("if [ -x /etc/init.d/astra-sm ]; then /etc/init.d/astra-sm start >/dev/null 2>&1; fi;",
                                 status_text="Starting Astra-SM...")
            return

        self["info"].setText("Starting Astra-SM...")
        self.runCommandAsync("if [ -x /etc/init.d/astra-sm ]; then /etc/init.d/astra-sm start >/dev/null 2>&1; fi;",
                             done_cb=self._installFinish,
                             status_text="Starting Astra-SM...")

    def _retryCopyNow(self):
        # Stop astra once more then retry copying
        self["status"].setText("Retrying copy...")
        stop_cmd = (
            "if [ -x /etc/init.d/astra-sm ]; then /etc/init.d/astra-sm stop >/dev/null 2>&1; fi; "
            "killall -9 astra-sm >/dev/null 2>&1; "
        )
        self.runCommandAsync(stop_cmd, done_cb=self._copyPluginFiles, status_text="Stopping Astra-SM (retry)...")

    def _installFinish(self, retval):
        self["status"].setText("Install done. Press BLUE for Motor Settings list.")
        self["info"].setText(
            "Installation successful!\n\n"
            "Next step:\n"
            "- Press BLUE (Motor Settings) to install the latest 'ciefp-E2-75E-34W' channel list and reload settings."
        )
        self.session.open(MessageBox,
                          "Files copied and Astra-SM restarted.\n\nNow press BLUE (Motor Settings) to install the latest motor list and reload.",
                          MessageBox.TYPE_INFO)

    def _pick_latest_motor_zip(self, items):
        best_url = None
        best_dt = None
        for it in items:
            name = it.get("name", "")
            m = MOTOR_ZIP_PATTERN.match(name)
            if not m:
                continue
            date_str = m.group(1)
            try:
                dt = datetime.strptime(date_str, "%d.%m.%Y")
            except Exception:
                dt = None

            url = it.get("download_url")
            if not url:
                continue

            if best_url is None:
                best_url, best_dt = url, dt
                continue

            if dt and best_dt:
                if dt > best_dt:
                    best_url, best_dt = url, dt
            elif dt and not best_dt:
                best_url, best_dt = url, dt
        return best_url, best_dt

    def getLatestMotorZipUrl(self):
        try:
            resp = urlopen(GITHUB_ZIPPED_ROOT_API, timeout=20)
            items = json.loads(resp.read().decode("utf-8"))
            return self._pick_latest_motor_zip(items)
        except Exception as e:
            self["status"].setText("GitHub fetch error: %s" % str(e))
            return None, None

    def installMotorSettings(self):
        self["status"].setText("Checking latest Motor Settings ZIP...")
        zip_url, zip_dt = self.getLatestMotorZipUrl()
        if not zip_url:
            self["status"].setText("No matching motor ZIP found on GitHub.")
            return

        shown_ver = zip_dt.strftime("%d.%m.%Y") if zip_dt else "unknown"
        self["info"].setText("Installing Motor Settings...\n\nFound version: %s\nSource:\n%s" % (shown_ver, zip_url))

        cmd = (
            "opkg install unzip >/dev/null 2>&1; "
            "rm -rf /tmp/ciefp_motor /tmp/ciefp_motor.zip; "
            "mkdir -p /tmp/ciefp_motor; "
            "wget -O /tmp/ciefp_motor.zip \"%s\" >/dev/null 2>&1; "
            "unzip -o /tmp/ciefp_motor.zip -d /tmp/ciefp_motor >/dev/null 2>&1; "
            "cp -rf /tmp/ciefp_motor/*/* /etc/enigma2/ >/dev/null 2>&1; "
            "if [ -f /tmp/ciefp_motor/*/satellites.xml ]; then "
            "  mkdir -p /etc/tuxbox/; "
            "  cp -f /tmp/ciefp_motor/*/satellites.xml /etc/tuxbox/ >/dev/null 2>&1; "
            "fi; "
            "sync; "
            "rm -rf /tmp/ciefp_motor /tmp/ciefp_motor.zip; "
        ) % zip_url

        self.runCommandAsync(cmd, done_cb=self._motorSettingsDone, status_text="Installing Motor Settings...")

    def _motorSettingsDone(self, retval):
        if retval != 0:
            self["status"].setText("Motor Settings install failed (code %d)." % retval)
            return
        try:
            db = eDVBDB.getInstance()
            db.reloadServicelist()
            db.reloadBouquets()
            self["status"].setText("Motor Settings installed & reloaded successfully.")
        except Exception as e:
            self["status"].setText("Installed, but reload failed: %s" % str(e))

    def exitPlugin(self):
        self.close()


def Plugins(**kwargs):
    return [
        PluginDescriptor(
            name=PLUGIN_NAME,
            description="Installer for T2MI Abertis configuration (Version %s)" % PLUGIN_VERSION,
            where=[PluginDescriptor.WHERE_PLUGINMENU, PluginDescriptor.WHERE_EXTENSIONSMENU],
            icon=ICON_PATH,
            fnc=lambda session, **kwargs: session.open(CiefpSettingsT2miAbertis)
        )
    ]
